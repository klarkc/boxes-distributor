<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="boxes-box.html">
<link rel="import" href="packer-behavior.html">

<!--
This element distributes boxes with a ideal layout to use the maximum of available space in trucks

Example:

    <boxes-distributor
                       truck-width='300'
                       truck-height='192'
                       box-width='54'
                       box-height='42'
                       >
    </boxes-distributor>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="boxes-distributor">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        box-sizing: border-box;
      }

      #container {
        background-color: var(--dark-theme-background-color);
        position: relative;
        margin-top: 226px;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 88px;
      }

      #container .info {
        line-height: 50px;
        position: absolute;
        bottom: -86px;
        width: 100%;
      }

      #container .info.top {
        bottom: inherit;
        top: -208px;
      }

      #efficiency {
        color: red;
      }

      #slider {
        width: 100%;
      }
    </style>


    <paper-material id="container">
      <paper-material class="info top layout vertical">
        <div class="layout horizontal around-justified">
            <paper-input type="number" label="Truck width" value="{{truckWidth}}"></paper-input>
            <paper-input type="number" label="Truck height" value="{{truckHeight}}"></paper-input>
        </div>
        <div class="layout horizontal around-justified">
          <paper-input type="number" label="Box width" value="{{boxWidth}}"></paper-input>
          <paper-input type="number" label="Box height" value="[[boxHeight]]"></paper-input>
        </div>
        <paper-slider id="slider" label = "Scale" min="1" max="3" step="0.1" value="{{scale}}"></paper-slider>
      </paper-material>

      <template is="dom-repeat" items="{{boxes}}">
        <boxes-box box="{{item}}" scale="{{scale}}"></boxes-box>
      </template>

      <paper-material class="info layout horizontal around-justified">
        <p><span id="total">Number of boxes: 0</span></p>
        <p><span id="efficiency">Layout efficiency: 0%</span></p>
      </paper-material>
    </paper-material>
  </template>

  <script>
    Polymer({
      is: 'boxes-distributor',

      properties: {
        /**
         * `truckWidth` width of the truck in pixels
         */
        truckWidth: {
          type: Number,
          notify: true
        },

        /**
         * `truckHeight` height of the truck in pixels
         */
        truckHeight: {
          type: Number,
          notify: true
        },

         /**
         * `boxWidth` height of the truck in pixels
         */
        boxWidth: {
          type: Number,
          notify: true
        },

         /**
         * `boxHeight` height of the truck in pixels
         */
        boxHeight: {
          type: Number,
          notify: true,
        },

        /**
         * `boxes` the calculated boxes
         */
        boxes: {
          type: Array,
          readOnly: true,
          notify: true
        },

        /**
         * `scale` the scale multiplier of all the sizes
         */
        scale: {
          type: Number,
          value: 1,
          notify: true
        }
      },

      observers: [
        '_setTruck(truckWidth, truckHeight, scale)',
        '_calculateBoxes(truckWidth, truckHeight, boxWidth, boxHeight, scale)',
        '_generateTree(truckWidth, truckHeight, boxes, scale)'
      ],

      listeners: {
        'packed': '_handlePacked'
      },

      behaviors: [PackerBehavior],

      // Element Lifecycle

      // Element Behavior

      /**
       * Calculate the array of boxes
       * @param {number} tW Width of the truck
       * @param {number} tH Height of the truck
       * @param {number} bW Width of the boxes
       * @param {number} bH Height of the boxes
       */
      _calculateBoxes: function(tW, tH, bW, bH) {
        console.log(tW,tH,bW,bH);
        let tArea = tW * tH;
        let bArea = bW * bH;
        let boxes = new Array(Math.floor(tArea / bArea));
        let bId = 0;
        boxes = boxes.fill(null).map(function(){return {w: bW, h: bH, _id: ++bId}});

        // Define the tries
        this.tries = [];

        // Finished status
        this.finished = false;

        this._setBoxes(boxes);
      },

      _calculateEfficiency: function(boxes) {
        let total = boxes.length;

        let fit =  boxes.filter(function(box){
          return box.fit;
        }).length;

        if(!fit) {
          this.$.efficiency.innerHTML = 'Layout efficiency: 0%';
          this.$.efficiency.style.color = 'red';
          return 0;
        }

        let eff = 100 * fit / total;
        this.$.efficiency.innerHTML = 'Layout efficiency: ' + eff + '%';
        this.$.total.innerHTML = 'Number of boxes: ' + fit;
        if(eff >= 50) this.$.efficiency.style.color = 'orange';
        if(eff >= 80) this.$.efficiency.style.color = 'green';
        console.log('efficiency', eff);
        return eff;
      },

      _setTruck: function(tW, tH) {
        this.$.container.style.width = tW * this.scale + 'px';
        this.$.container.style.height = tH * this.scale + 'px';
      },

      _handlePacked: function(e) {
        if(this.finished) {
          console.log('already finished, skipping handlePacked');
          return;
        }


        if(this.tries.length > 20) {
          this._setBestTry();
          console.log('max tries reached, finishing');
          return;
        }

        let eff = this._calculateEfficiency(e.detail);
        if( eff >= 99.9) {
          console.log('max eficiency reached, finishing');
          return;
        } else if (this.tries.length > 0){
          this.tries[this.tries.length - 1].efficiency = eff;
        }

        let missingBoxes = e.detail.filter(function(box){
          return !box.fit;
        });

        let rotatedBoxes = missingBoxes.map(this._rotateBox);

        let boxes = this._unFit(e.detail).map(function(box){
          let rbox = rotatedBoxes.filter(function(rBox){
            return rBox._id === box._id;
          });
          return rbox[0] || box;
        }).sort(this._sort.maxside);

        let lastTry = this.tries[this.tries.length - 1];
        let rotatedIds = rotatedBoxes.map(function(b){return b._id});
        if( lastTry && this._arrayEqual(lastTry.rotatedIds, rotatedIds)) {
          console.log('last try was the same, stoping the efficiency search');
          this._setBestTry();
          return;
        }

        this.tries.push({boxes: boxes, rotatedIds: rotatedIds});

        console.log('retrying with rotated', rotatedIds);
        this._setBoxes(boxes);
      },

      _rotateBox: function(box) {
        return {w: box.h, h: box.w, _id: box._id};
      },

      _unFit: function(boxes) {
        return boxes.map(function(box){
          delete box.fit;
          return box;
        });
      },

      _setBestTry: function() {
        this.tries = this.tries.sort(function(a, b){
          return a.efficiency < b.efficiency;
        });
        let bestTry = this._unFit(this.tries[0].boxes);
        this.finished = true;
        this._setBoxes(bestTry);
        this._calculateEfficiency(bestTry);
      },

      _arrayEqual: function(a, b) {
        var i = a.length;
        if (i != b.length) return false;
        while (i--) {
          if (a[i] !== b[i]) return false;
        }
        return true;
      }
    });
  </script>
</dom-module>
